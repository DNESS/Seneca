<html>
	<head>
		<title>PyMon Web</title>
		
		<link href="/scripts/bootstrap.css" rel="stylesheet">
		<link href="/scripts/bootstrap-responsive.css" rel="stylesheet">
		
		<script src="/scripts/jquery.js"></script>
		
		<style>
			body
			{
				margin: 5px;
			}
			
			.hide
			{
				display: none;
			}
			
			.small
			{
				width: 0px;
				white-space: nowrap;
			}
			
			.big
			{
				width: 100%%;
			}
			
			.mono
			{
				font-family: Courier New;
				font-size: 10px;
			}
			
			
			.label
			{
				padding-top: 1px;
				padding-bottom: 1px;
			}
			
			.btn-toolbar
			{
				margin-top: 0px;
				margin-bottom: 0px;
			}
		</style>
		
		<script>
			var data = %(data)s;
			var sepr = " ";
			var cheklist = {};
			
			cheklist["System" + sepr + "Information"] = function (valulist) {
				var datestri = valulist[2];
				
				var d = new Date();
				var utcodate = Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds());
				var hostdate = new Date(datestri);
				var diffnumb = parseInt((utcodate - hostdate.getTime()) / 1000);
				var warntime = parseInt(2.5 * 60);
				var impotime = (2 * warntime);
				
				if (diffnumb >= impotime)
				{
					return "danger";
				}
				
				if (diffnumb >= warntime)
				{
					return "warning";
				}
				
				return "";
			};
			
			cheklist["Mounts" + sepr] = function (valulist) {
				var mntfs = valulist[1];
				var mntopts = valulist[2];
				
				if (mntopts.substring(0, 2) != "rw")
				{
					return "danger";
				}
				
				if ((mntfs != "ext4") && (mntfs != "nfs4"))
				{
					return "warning";
				}
				
				return "";
			};
			
			cheklist["Directories" + sepr] = function (valulist) {
				
				
				return "";
			};
			
			function show(objc)
			{
				var colsobjc = document.getElementById("colslist");
				var dataobjc = document.getElementById("datalist");
				var objclist = document.getElementsByName(objc.id);
				
				var colsrows = colsobjc.getElementsByTagName("tr");
				var datarows = dataobjc.getElementsByTagName("td");
				
				for (var indx in colsrows)
				{
					if (indx < 1)
					{
						continue;
					}
					
					if (colsrows[indx].style)
					{
						colsrows[indx].style.display = "none";
					}
				}
				
				for (var indx in datarows)
				{
					if (datarows[indx].className)
					{
						if (datarows[indx].className.match(/^.*(host|stat).*$/))
						{
							continue;
						}
					}
					
					if (datarows[indx].style)
					{
						datarows[indx].style.display = "none";
					}
				}
				
				for (var indx in objclist)
				{
					if (objclist[indx].style)
					{
						objclist[indx].style.display = "";
					}
				}
			}
			
			function rate(a, b)
			{
				if ((a == "important") || (b == "important"))
				{
					return "important";
				}
				
				if ((a == "warning") || (b == "warning"))
				{
					return "warning";
				}
				
				return "success";
			}
			
			function init()
			{
				var menuobjc = document.getElementById("menulist");
				var colsobjc = document.getElementById("colslist");
				var dataobjc = document.getElementById("datalist");
				
				var menulist = [], subslist = {}, menuspan = 1;
				var colslist = {}, datalist = [];
				var errolist = {};
				
				var htmlstri = "", rowsnumb = 0, colsnumb = 0;
				
				/* parse thru the data to setup the above variables */
				
				for (var indx in data)
				{
					var hostname = data[indx]["name"];
					var hostdata = data[indx]["data"];
					
					var tempdata = {};
					
					for (var menuindx in hostdata)
					{
						var menuname = hostdata[menuindx]["name"];
						var subsdata = hostdata[menuindx]["subs"];
						
						if (menulist.indexOf(menuname) < 0)
						{
							menulist.splice(menuindx, 0, menuname);
						}
						
						if (!(menuname in subslist))
						{
							subslist[menuname] = [];
						}
						
						for (var subsindx in subsdata)
						{
							var subsname = subsdata[subsindx]["name"];
							var colsdata = subsdata[subsindx]["cols"];
							
							if (subslist[menuname].indexOf(subsname) < 0)
							{
								subslist[menuname].splice(subsindx, 0, subsname);
							}
							
							menuspan = Math.max(menuspan, colsdata.length);
							
							for (var colsindx in colsdata)
							{
								var colsname = colsdata[colsindx]["name"];
								var colsvalu = colsdata[colsindx]["value"];
								var colskeyn = (menuname + sepr + subsname);
								
								if (!(colskeyn in colslist))
								{
									colslist[colskeyn] = [];
								}
								
								if (colslist[colskeyn].indexOf(colsname) < 0)
								{
									colslist[colskeyn].splice(colsindx, 0, colsname);
								}
								
								if (!(colskeyn in tempdata))
								{
									tempdata[colskeyn] = [];
								}
								
								tempdata[colskeyn].push(colsvalu);
							}
						}
					}
					
					datalist.push([hostname, tempdata]);
				}
				
				menuspan += 2;
				
				/* output the generated menus and submenus based on the collected data */
				
				htmlstri = "";
				
				htmlstri += ("<td colspan='" + menuspan + "'>");
				htmlstri += ("<div class='btn-toolbar'>");
				
				for (var menuindx in menulist)
				{
					var menuname = menulist[menuindx];
					
					htmlstri += ("<div class='btn-group'>");
					htmlstri += ("<button class='btn btn-primary dropdown-toggle' data-toggle='dropdown'>" + menuname + " <span class='caret'></span></button>");
					htmlstri += ("<ul class='dropdown-menu'>");
					
					for (var subsindx in subslist[menuname])
					{
						var subsname = subslist[menuname][subsindx];
						var colskeyn = (menuname + sepr + subsname);
						
						htmlstri += ("<li><a href='#' id='" + colskeyn + "' onclick='show(this);'>" + subsname + "</a></li>");
					}
					
					htmlstri += ("</ul>");
					htmlstri += ("</div>");
				}
				
				htmlstri += ("</div>");
				htmlstri += ("</td>");
				
				menuobjc.innerHTML += htmlstri;
				
				/* output the generated columns based on the collected data */
				
				htmlstri = "";
				
				for (var colskeyn in colslist)
				{
					var colsdata = colslist[colskeyn];
					
					htmlstri += ("<tr name='" + colskeyn + "' style='display: none;'>");
					
					htmlstri += ("<th class='small' style='vertical-align: middle; text-align: right;'>");
					htmlstri += ("<span class='label label-inverse'>Hostname</span>");
					htmlstri += ("</th>");
					
					htmlstri += ("<th class='small' style='vertical-align: middle; text-align: center;'>");
					htmlstri += ("<span class='label label-inverse'>Status</span>");
					htmlstri += ("</th>");
					
					htmlstri += ("<th class='small'> &nbsp; </th>");
					
					for (var colsindx in colsdata)
					{
						var colsname = colsdata[colsindx];
						var clasname = "small";
						
						if (colsindx == (colsdata.length - 1))
						{
							clasname = "big";
						}
						
						htmlstri += ("<td class='" + clasname + "' style='vertical-align: middle; text-align: left;'>");
						htmlstri += ("<span class='label label-info'>" + colsname + "</span>");
						htmlstri += ("</td>");
					}
					
					htmlstri += ("</tr>\n");
				}
				
				colsobjc.innerHTML += htmlstri;
				
				/* output the generated values based on the collected data */
				
				for (var indx in datalist)
				{
					var hostname = datalist[indx][0];
					var hostdata = datalist[indx][1];
					
					htmlstri = "";
					rowsnumb = 0;
					colsnumb = 0;
					
					errolist[hostname] = {"warning":"", "warning-numb":0, "warning-name":"W.", "danger":"", "danger-numb":0, "danger-name":"E.", "final":""};
					
					htmlstri += ("<tr>");
					htmlstri += ("<td class='small host' name='" + hostname + "' style='vertical-align: middle; text-align: right;'></td>");
					htmlstri += ("<td class='small stat' name='" + hostname + "-status' style='vertical-align: middle;'></td>");
					htmlstri += ("<td class='small stat'> &nbsp; </td>");
					
					for (var colskeyn in colslist)
					{
						if (!(colskeyn in hostdata))
						{
							hostdata[colskeyn] = [];
							
							for (var colsindx in colslist[colskeyn])
							{
								hostdata[colskeyn].push(" &nbsp; ");
							}
						}
					}
					
					for (var datakeyn in hostdata)
					{
						var datadata = hostdata[datakeyn];
						
						for (var checkeyn in cheklist)
						{
							var keynleng = checkeyn.length;
							
							if (checkeyn == datakeyn.substr(0, keynleng))
							{
								var funcobjc = cheklist[checkeyn];
								var funcoutp = funcobjc(datadata);
								
								if (!funcoutp)
								{
									continue;
								}
								
								errolist[hostname][funcoutp] += ("<li><a href='#' id='" + datakeyn + "' onclick='show(this);'>" + datakeyn + "</a></li>");
								errolist[hostname][funcoutp + "-numb"] += 1;
							}
						}
						
						for (var dataindx in datadata)
						{
							var datavalu = datadata[dataindx];
							var clasname = "small";
							
							if (dataindx == (datadata.length - 1))
							{
								clasname = "big";
							}
							
							htmlstri += ("<td class='" + clasname + " mono' name='" + datakeyn + "' style='vertical-align: middle; text-align: left; display: none;'>" + datavalu + "</td>");
							colsnumb += 1;
						}
					}
					
					htmlstri += ("</tr>\n");
					rowsnumb += 1;
					
					/*if ((rowsnumb %% 2) == 0)
					{
						htmlstri += ("<tr style='display: none;'><td> &nbsp; </td></tr>\n");
					}*/
					
					dataobjc.innerHTML += htmlstri;
					
					var keyslist = ["warning", "danger"];
					
					for (var keysindx in keyslist)
					{
						var keysname = keyslist[keysindx];
						var butntext = (errolist[hostname][keysname + "-name"] + " [" + errolist[hostname][keysname + "-numb"] + "]");
						var begihtml = "", endihtml = "";
						
						begihtml += ("<div class='btn-group'>");
						begihtml += ("<button class='btn btn-" + keysname + " dropdown-toggle btn-mini' data-toggle='dropdown'>" + butntext + " <span class='caret'></span></button>");
						
						if (errolist[hostname][keysname])
						{
							errolist[hostname][keysname] = ("<ul class='dropdown-menu'>" + errolist[hostname][keysname] + "</ul>");
						}
						
						endihtml += ("</div>");
						
						errolist[hostname]["final"] += (begihtml + errolist[hostname][keysname] + endihtml);
					}
				}
				
				/* output the generated hosts and warnings based on the collected data */
				
				for (var indx in datalist)
				{
					var hostname = datalist[indx][0];
					var htmllist = [];
					
					htmllist = document.getElementsByName(hostname);
					
					for (var htmlindx in htmllist)
					{
						htmllist[htmlindx].innerHTML = ("<span class='label label-info'>" + hostname + "</span>");
					}
					
					htmllist = document.getElementsByName(hostname + "-status");
					
					for (var htmlindx in htmllist)
					{
						htmllist[htmlindx].innerHTML = ("<div class='btn-toolbar'>" + errolist[hostname]["final"] + "</div>");
					}
				}
				
				show({"id":"System Information"});
			}
		</script>
	</head>
	
	<body onload="init();">
		<p> &nbsp; </p>
		
		<center><table class='table table-striped table-bordered table-condensed' style='width: 1096px;'>
			<thead id='colslist'>
				<tr id='menulist'>
					<th class='small' style=' vertical-align: middle; text-align: center;'>PyMon Web</th>
				</tr>
			</thead>
			
			<tbody id='datalist'></tbody>
		</table></center>
		
		<p> &nbsp; </p>
		<p> &nbsp; </p>
		<p> &nbsp; </p>
		<p> &nbsp; </p>
		<p> &nbsp; </p>
		
		<script src="/scripts/tb/js/bootstrap-transition.js"></script>
		<script src="/scripts/tb/js/bootstrap-alert.js"></script>
		<script src="/scripts/tb/js/bootstrap-modal.js"></script>
		<script src="/scripts/tb/js/bootstrap-dropdown.js"></script>
		<script src="/scripts/tb/js/bootstrap-scrollspy.js"></script>
		<script src="/scripts/tb/js/bootstrap-tab.js"></script>
		<script src="/scripts/tb/js/bootstrap-tooltip.js"></script>
		<script src="/scripts/tb/js/bootstrap-popover.js"></script>
		<script src="/scripts/tb/js/bootstrap-button.js"></script>
		<script src="/scripts/tb/js/bootstrap-collapse.js"></script>
		<script src="/scripts/tb/js/bootstrap-carousel.js"></script>
		<script src="/scripts/tb/js/bootstrap-typeahead.js"></script>
	</body>
</html>
